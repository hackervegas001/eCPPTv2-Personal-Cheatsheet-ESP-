
Los Kernel exploits son uno de los métodos más prolíficos para escalar privilegios en máquinas Linux cuando los kernels están desactualizados. Se encuentran nuevas vulnerabilidades, y exploits son desarrollados prácticamente mensualmente para varias distribuciones y arquitecturas.

*Algunos ejemplos de vulnerabilidades de escaladas de privilegios y exploits asociados con el kernel de Linux incluyen:

[Dirty Cow](https://github.com/dirtycow/dirtycow.github.io/wiki/VulnerabilityDetails) Existente en versiones kernel desde la 2.6.22 (2007) y fixeado en 2016.

[Stack Clash (Varias distribuciones/Kernels)](https://blog.qualys.com/securitylabs/2017/06/19/the-stack-clash)

[DCCP Double-Free Privilege Escalation (4.4.0 kernel/ubuntu)](https://www.exploit-db.com/exploits/41458/)

[Race Condition Privilege Escalation (Linux kernel < 4.10.15)](https://www.exploit-db.com/exploits/43345/)

Hay muchos tipos de Kernel Exploits, los más comunes son:

```
Buffer Overflows
Memory Corruption
Denial-of-service
Race Conditions
```

Excepto la denegación de servicios, la mayoría permiten ejecución arbitraria de comandos y escalada de privilegios.

Si buscamos en [cvedetails.com](www.cvedetails.com) encontraremos que algunas de las más altas vulnerabilidades que afectan al kernel de Linux tienen un CVSS de 10.

Los exploits de kernel de linux normalmente serán binarios ELF pre-compilados, o scripts hechos en C (archivos .c), los cuales compilaremos nosotros mismos, o estarán disponibles en exploit frameworks como Metasploit.

**ES IMPORTANTE SABER LO QUE HACE EL EXPLOIT PARA NO COMPROMETER NUESTRO PROPIO SISTEMA. Puede estar mandando una reverse shell a un sistema atacante, puede abrir una bind shell hacia nuestro sistema, o puede eliminar todo nuestro sistema operativo con un comando como el de abajo. 

	(rm -rf /*)

Para encontrar nuestro exploit de kernel adecuado usaremos searchsploit

```
searchsploit linux kernel DISTRIBUCIÓN/versión
```

Otra herramienta excelente escrita en Perl es [Linux exploit suggester](https://github.com/InteliSecureLabs/Linux_Exploit_Suggester)

Podemos lanzarlo de forma local en nuestra máquina atacante ejecutando el siguiente comando, indicandole la versión del kernel objetivo.

```
perl Linux_Exploit_Suggester.pl -k version
```

O podemos lanzarlo desde la máquina víctima, de forma que el mismo determinará la versión de kernel con un uname -a

```
perl Linux_Exploit_Suggester.pl
```

Una vez hemos identificado el exploit válido, descargaremos el código fuente del exploit en el objetivo.

*Recordar que muchos exploits no son simplemente lanzarlos y ya está, algunos requieren de parámetros.

Un ejemplo de esto es el [UDEV <1.4.1 -Local Privilege Escalation](https://www.exploit-db.com/exploits/8572/), exploit que afecta a las versiones 2.6 del kernel y que requiere que determinamos el PID (id de proceso) de "udevd netlink socket", y también requiere que creemos un archivo "/tmp/run el cual contiene el código que queramos que se ejecute como root."

Una vez hemos descargado el exploit en el sistema objetivo, podemos compilarlo.

*Uno de los requerimientos para compilarlos esque gcc (GNU C/C++ Compiler) esté instalado en el objetivo, podemos determinar si está instalado lanzando el comando gcc --version. Si está instalado, veremos un output así.

![[Pasted image 20230129143239.png]]

Para compilar un exploit, a veces puede ser tan simple como lanzar el siguiente comando:

```
gcc exploit.c -o exploit
```

El exploit compilado se llamará exploit.

Una vez compilado le damos permisos de ejecución y lo ejecutamos.

```
chmod +x exploit
./exploit
```

Las instrucciones de compilado también pueden venir dentro del código fuente del exploit, por ejemplo, éstas son las instrucciones del exploit *sys_chown missing DAC controls en Linux (CVE-2004-0497)*, exploit que afecta a las versiones 2.x de kernel.

![[Pasted image 20230129143558.png]]

A veces, nos veremos en una situación en que la máquina objetivo es de 32 bits y no tiene gcc instalado, y tendremos que compilarlo desde la máquina atacante.

```
gcc -m32 exploit.c -o exploit
```

Metasploit también contiene un montón de exploits de kernel que podemos usar si encontramos que nuestro objetivo es vulnerable.

A parte de Metasploit y searchsploit, tenemos otra fuente, el cual es un nuevo exploit framework diseñado para objetivos Linux y Mac, conocido como [Kernelpop](https://github.com/spencerdodd/kernelpop), requiere tener python3 instalado.

*Repositorios de kernel exploits

[SecWiki-Linux-Kernel-Exploits](https://github.com/SecWiki/linux-kernel-exploits)
[Exploit db](http://exploit-db.com/)
[lucyoa kernel-exploits](https://github.com/lucyoa/kernel-exploits)

